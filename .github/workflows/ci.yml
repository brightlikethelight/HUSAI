name: CI

on:
  pull_request:
  push:
    branches: [main]

jobs:
  smoke:
    name: Smoke (Fail Fast)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      KMP_DUPLICATE_LIB_OK: "TRUE"
      TMPDIR: /tmp
      MPLCONFIGDIR: /tmp/mpl
      PYTHONUNBUFFERED: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-dev.txt

      - name: Run fail-fast smoke pipeline
        run: scripts/ci/smoke_pipeline.sh /tmp/husai_ci_smoke

  quality:
    name: Lint + Typecheck + Pytest
    runs-on: ubuntu-latest
    needs: smoke
    timeout-minutes: 25
    env:
      KMP_DUPLICATE_LIB_OK: "TRUE"
      TMPDIR: /tmp
      MPLCONFIGDIR: /tmp/mpl
      PYTHONUNBUFFERED: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-dev.txt

      - name: Lint (incremental gate)
        run: |
          flake8 src/utils/config.py src/data/modular_arithmetic.py \
            scripts/experiments/run_phase4a_reproduction.py \
            scripts/experiments/run_core_ablations.py \
            scripts/experiments/run_external_benchmark_slice.py \
            scripts/experiments/run_official_external_benchmarks.py \
            scripts/experiments/run_cebench_compat.py \
            scripts/experiments/run_transcoder_stress_eval.py \
            scripts/experiments/run_ood_stress_eval.py \
            --max-line-length 130 --extend-ignore=E402

      - name: Script syntax smoke
        run: |
          python -m py_compile \
            scripts/experiments/run_official_external_benchmarks.py \
            scripts/experiments/run_cebench_compat.py \
            scripts/experiments/run_transcoder_stress_eval.py \
            scripts/experiments/run_ood_stress_eval.py

      - name: Typecheck (incremental gate)
        run: mypy src/utils/config.py src/data/modular_arithmetic.py

      - name: Pytest
        run: pytest tests -q
